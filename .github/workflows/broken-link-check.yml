name: "Broken Link Check"

on:
  schedule:
    - cron: 0 0 * * 0 # run every Sunday at midnight
  push:
    branches:
      - cr/dpc-4709
  pull_request: 
    paths:
      - .github/workflows/**
  

jobs:
  check:
    name: "Check for broken links"
    runs-on: ubuntu-latest
    steps:
      - name: "Checkout code"
        uses: actions/checkout@v2
      - name: "Check for broken links"
        uses: lycheeverse/lychee-action@82202e5e9c2f4ef1a55a3d02563e1cb6041e5332 # v2.4.1
        id: lychee
        with:
          jobSummary: true
          args: --no-progress --accept '200..=299, 401, 403, 404, 405' .
      - name: "Send Slack alert"
        if: steps.lychee.outputs.exit_code != 0
        uses: slackapi/slack-github-action@v2.1.0
        with:
          webhook: ${{ secrets.LINK_CHECK_SLACK_WEBHOOK_URL }}
          webhook-type: webhook-trigger
          payload: |
            "Details": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
      - name: "Fail workflow"
        if: steps.lychee.outputs.exit_code != 0
        run: exit ${{ env.lychee_exit_code }}
